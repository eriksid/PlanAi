 O proxy de imagens no SnappyMail funciona como um intermediário para proteger a privacidade do usuário e evitar problemas de conteúdo misto (mixed content).

  Aqui está o funcionamento detalhado com base no código analisado:

  1. Configuração
  O recurso é controlado pela configuração use_local_proxy_for_external_images. Quando ativado no painel de administração, o frontend passa a reescrever as URLs das imagens externas.

  2. Frontend (JavaScript)
  Quando uma mensagem é exibida e o proxy está ativo, o código JavaScript (em dev/Model/Message.js e dev/Common/Links.js):
   1. Identifica imagens externas (src ou estilos url()).
   2. Codifica a URL original da imagem em Base64 (tornando-a segura para URL).
   3. Substitui a URL original por um link interno que aponta para o serviço de proxy do SnappyMail.
       * Formato: /?/ProxyExternal/<URL_EM_BASE64>

  3. Backend (PHP)
  Quando o navegador solicita essa URL interna, o método ServiceProxyExternal (em app/libraries/RainLoop/ServiceActions.php) entra em ação:
   1. Decodificação: Recebe o parâmetro da URL e o decodifica de Base64 para obter o endereço original da imagem.
   2. Validação: Verifica se a decodificação resultou em uma URL válida.
   3. Requisição (Fetch): O servidor do SnappyMail faz uma requisição HTTP (GET) para a URL da imagem original.
       * Isso é feito usando a classe \SnappyMail\HTTP\Request.
       * O corpo da resposta é gravado em um arquivo temporário (tmpfile()) para não sobrecarregar a memória RAM.
   4. Verificação de Tipo: Confirma se a resposta do servidor remoto é realmente uma imagem (o Content-Type deve começar com image/ e o status deve ser 200 OK).
   5. Entrega: Se for válido, o servidor define os cabeçalhos apropriados (Content-Type, Cache-Control) e envia o conteúdo da imagem (o arquivo temporário) para o navegador do usuário.

  Benefícios
   * Privacidade: O remetente do e-mail não vê o seu endereço IP nem sabe que você abriu a imagem (bloqueia rastreadores de pixel), pois a requisição vem do servidor do SnappyMail.
   * Segurança (HTTPS): Se você acessa o webmail via HTTPS e a imagem original é HTTP, o proxy carrega a imagem e a entrega via HTTPS, evitando avisos de "Conteúdo não seguro" no navegador.


---

 # Como Funciona o Proxy de Imagens no SnappyMail                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                         
  ## Visão Geral                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                         
  O proxy de imagens é um recurso de segurança e privacidade que intercepta imagens externas em emails e as serve através do servidor SnappyMail, em vez de carregá-las diretamente de servidores externos.                                                              
                                                                                                                                                                                                                                                                         
  ---                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                         
  ## Fluxo de Funcionamento                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                         
  ### 1. Limpeza do HTML (Frontend)                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                         
  Quando um email é exibido, a função `cleanHtml()` em `dev/Common/Html.js:269` processa o HTML:                                                                                                                                                                         
                                                                                                                                                                                                                                                                         
  - **Detecção de imagens externas**: Imagens com URLs HTTP/HTTPS externas são identificadas                                                                                                                                                                             
  - **Marcação**: O atributo `src` é removido e o URL original é salvo em `data-x-src`                                                                                                                                                                                   
  - **Detecção de tracking**: URLs de rastreamento são detectados e marcados separadamente em `data-x-src-hidden`                                                                                                                                                        
  - A flag `hasExternals` é definida para indicar que existem imagens externas                                                                                                                                                                                           
                                                                                                                                                                                                                                                                         
  ```javascript                                                                                                                                                                                                                                                          
  if (httpre.test(value)) {                                                                                                                                                                                                                                              
      setAttribute('data-x-src', src);                                                                                                                                                                                                                                   
      result.hasExternals = true;                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                                      
 ```                                                                                                                                                                                                                                                                        
  ---                                                                                                                                                                                                                                                                    
  2. Exibição de Imagens                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                         
  Quando o usuário decide mostrar as imagens (dev/Model/Message.js:543):                                                                                                                                                                                                 
                                                                                                                                                                                  ```                                                                                       
  showExternalImages(mode) {                                                                                                                                                                                                                                             
      const useProxy = !!SettingsGet('proxyExternalImages');                                                                                                                                                                                                             
      body.querySelectorAll('img[data-x-src]').forEach(node => {                                                                                                                                                                                                         
          src = node.getAttribute('data-x-src');                                                                                                                                                                                                                         
          if (isValid(src)) {                                                                                                                                                                                                                                            
              node.src = useProxy ? proxy(src) : src;                                                                                                                                                                                                                    
          }                                                                                                                                                                                                                                                              
      });                                                                                                                                                                                                                                                                
  }                                                                                                                                                                             ```                                                                                         
                                                                                                                                                                                                                                                                         
  Verificação: A configuração proxyExternalImages determina se o proxy será usado.                                                                                                                                                                                       
                                                                                                                                                                                                                                                                         
  ---                                                                                                                                                                                                                                                                    
  3. Função Proxy (Frontend)                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                         
  Em dev/Common/Links.js:46, a função proxy() converte o URL:                                                                                                                                                                                                            
                                                                                                                                                                                  ```                                                                                       
  proxy = url =>                                                                                                                                                                                                                                                         
      BASE + '?/ProxyExternal/'                                                                                                                                                                                                                                          
      + btoa(url.replace(/ /g, '%20'))                                                                                                                                                                                                                                   
          .replace(/\+/g, '-')                                                                                                                                                                                                                                           
          .replace(/\//g, '_')                                                                                                                                                                                                                                           
          .replace(/=+$/, '')                                                                                                                                                                                                                                            
    ```                                                                                                                                                                                                                                                                     
  Exemplo de transformação:                                                                                                                                                                                                                                              
  URL original: https://example.com/image.jpg                                                                                                                                                                                                                            
  URL proxy:    /?/ProxyExternal/aHR0cHM6Ly9leGFtcGxlLmNvbS9pbWFnZS5qcGc                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                         
  O URL é codificado em Base64 URL-safe (substituindo + por - e / por _).                                                                                                                                                                                                
                                                                                                                                                                                                                                                                         
  ---                                                                                                                                                                                                                                                                    
  4. Backend - Serviço de Proxy                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                         
  O endpoint ServiceProxyExternal() em snappymail/v/0.0.0/app/libraries/RainLoop/ServiceActions.php:279 processa a requisição:                                                                                                                                           
                                                                                                                                                                                  ```                                                                                       
  public function ServiceProxyExternal() : string                                                                                                                                                                                                                        
  {                                                                                                                                                                                                                                                                      
      $sData = empty($this->aPaths[1]) ? '' : $this->aPaths[1];                                                                                                                                                                                                          
      if ($sData && $this->Config()->Get('labs', 'use_local_proxy_for_external_images', false)) {                                                                                                                                                                        
          // 1. Verifica cache                                                                                                                                                                                                                                           
          $this->oActions->verifyCacheByKey($sData);                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                         
          // 2. Decodifica URL                                                                                                                                                                                                                                           
          $sUrl = \MailSo\Base\Utils::UrlSafeBase64Decode($sData);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                         
          // 3. Faz requisição HTTP para o servidor externo                                                                                                                                                                                                              
          $tmp = \tmpfile();                                                                                                                                                                                                                                             
          $HTTP = \SnappyMail\HTTP\Request::factory();                                                                                                                                                                                                                   
          $HTTP->max_redirects = 2;                                                                                                                                                                                                                                      
          $HTTP->streamBodyTo($tmp);                                                                                                                                                                                                                                     
          $oResponse = $HTTP->doRequest('GET', $sUrl);                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                         
          // 4. Valida tipo de conteúdo                                                                                                                                                                                                                                  
          if (200 === $oResponse->status && \str_starts_with($sContentType, 'image/')) {                                                                                                                                                                                 
              // 5. Armazena em cache                                                                                                                                                                                                                                    
              $this->oActions->cacheByKey($sData);                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                         
              // 6. Serve a imagem com headers de cache                                                                                                                                                                                                                  
              header('Content-Type: ' . $sContentType);                                                                                                                                                                                                                  
              header('Cache-Control: public');                                                                                                                                                                                                                           
              header('Expires: ' . gmdate('D, j M Y H:i:s', 2592000 + time()) . ' UTC');                                                                                                                                                                                 
              header('X-Content-Redirect-Location: ' . $oResponse->final_uri);                                                                                                                                                                                           
              fpassthru($tmp);                                                                                                                                                                                                                                           
              exit;                                                                                                                                                                                                                                                      
          }                                                                                                                                                                                                                                                              
      }                                                                                                                                                                                                                                                                  
      // Retorna 404 se não autorizado ou erro                                                                                                                                                                                                                           
      \MailSo\Base\Http::StatusHeader(404);                                                                                                                                                                                                                              
      return '';                                                                                                                                                                                                                                                         
  }                                                                                                                                                                                                                                                                      
                                                                                                                                                                                       ```                                                                                  
                                                                                                                                                                                                                                                                         
  Processo:                                                                                                                                                                                                                                                              
  1. Decodifica o parâmetro Base64                                                                                                                                                                                                                                       
  2. Faz requisição HTTP ao servidor original                                                                                                                                                                                                                            
  3. Valida que o conteúdo é uma imagem                                                                                                                                                                                                                                  
  4. Armazena em cache                                                                                                                                                                                                                                                   
  5. Serve ao cliente com headers de cache (30 dias)                                                                                                                                                                                                                     
                                                                               
